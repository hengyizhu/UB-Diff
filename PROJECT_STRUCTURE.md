# UB-Diff é¡¹ç›®ç»“æ„æ€»è§ˆ

## é¡¹ç›®ç®€ä»‹

UB-Diffæ˜¯ä¸€ä¸ªç”¨äºåœ°éœ‡æ•°æ®å’Œé€Ÿåº¦åœºç”Ÿæˆçš„æ·±åº¦å­¦ä¹ é¡¹ç›®ï¼Œé‡‡ç”¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„ç»“åˆæ‰©æ•£æ¨¡å‹çš„æ–¹æ³•ã€‚é¡¹ç›®ç»è¿‡é‡æ„ï¼Œå…·æœ‰æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡å’Œå®Œæ•´çš„è®­ç»ƒ-ç”Ÿæˆpipelineã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
UB-Diff/
â”œâ”€â”€ model/                    # æ ¸å¿ƒæ¨¡å‹æ¨¡å—
â”‚   â”œâ”€â”€ components/          # æ¨¡å‹ç»„ä»¶
â”‚   â”œâ”€â”€ data/               # æ•°æ®å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ trainers/           # è®­ç»ƒå™¨æ¨¡å—
â”‚   â”œâ”€â”€ generation/         # æ•°æ®ç”Ÿæˆæ¨¡å—
â”‚   â””â”€â”€ ub_diff.py         # ä¸»æ¨¡å‹ç±»
â”œâ”€â”€ scripts/                # è®­ç»ƒå’Œç”Ÿæˆè„šæœ¬
â”œâ”€â”€ checkpoints/           # æ¨¡å‹æ£€æŸ¥ç‚¹
â”œâ”€â”€ generated_data/        # ç”Ÿæˆçš„æ•°æ®
â””â”€â”€ wandb/                # å®éªŒè®°å½•
```

## ğŸ“ è¯¦ç»†æ¨¡å—è¯´æ˜

### 1. Model æ ¸å¿ƒæ¨¡å— (`model/`)

#### 1.1 ä¸»æ¨¡å‹ç±» (`ub_diff.py`)
- **UBDiff**: æ•´ä¸ªé¡¹ç›®çš„æ ¸å¿ƒæ¨¡å‹ç±»
- æ•´åˆç¼–ç å™¨ã€è§£ç å™¨å’Œæ‰©æ•£æ¨¡å‹
- æä¾›è®­ç»ƒã€ç”Ÿæˆã€é‡æ„ç­‰æ ¸å¿ƒæ¥å£
- æ”¯æŒé¢„è®­ç»ƒæ¨¡å‹åŠ è½½å’Œæ£€æŸ¥ç‚¹ä¿å­˜

#### 1.2 æ¨¡å‹ç»„ä»¶ (`model/components/`)

| æ–‡ä»¶ | æ ¸å¿ƒç±»/åŠŸèƒ½ | ä½œç”¨æè¿° |
|------|------------|----------|
| `networks.py` | `ConvBlock`, `DeconvBlock`, `ResnetBlock`, `RMSNorm` | åŸºç¡€ç½‘ç»œå±‚å’Œæ„å»ºå— |
| `encoder.py` | `VelocityEncoder` | é€Ÿåº¦åœºç¼–ç å™¨ï¼Œå°†2Dé€Ÿåº¦åœºç¼–ç åˆ°æ½œåœ¨ç©ºé—´ |
| `decoder.py` | `VelocityDecoder`, `SeismicDecoder`, `DualDecoder` | å„ç§è§£ç å™¨ï¼Œä»æ½œåœ¨ç©ºé—´é‡æ„æ•°æ® |
| `attention.py` | `LinearAttention`, `Attention`, `VisionTransformer` | æ³¨æ„åŠ›æœºåˆ¶å’Œå˜æ¢å™¨ç»„ä»¶ |
| `diffusion.py` | `Unet1D`, `GaussianDiffusion1D` | 1Dæ‰©æ•£æ¨¡å‹å’ŒU-Netæ¶æ„ |
| `__init__.py` | - | æ¨¡å—å¯¼å‡ºå’Œæ¥å£å®šä¹‰ |

#### 1.3 æ•°æ®å¤„ç†æ¨¡å— (`model/data/`)

| æ–‡ä»¶ | æ ¸å¿ƒç±»/åŠŸèƒ½ | ä½œç”¨æè¿° |
|------|------------|----------|
| `dataset.py` | `SeismicVelocityDataset` | åœ°éœ‡æ•°æ®å’Œé€Ÿåº¦åœºæ•°æ®é›†ç±» |
| `transforms.py` | `LogTransform`, `MinMaxNormalize`, `å¤åˆå˜æ¢` | æ•°æ®é¢„å¤„ç†å’Œæ ‡å‡†åŒ–å˜æ¢ |
| `dataset_config.json` | - | å„æ•°æ®é›†çš„é…ç½®ä¿¡æ¯å’Œæ ‡å‡†åŒ–å‚æ•° |
| `__init__.py` | æ•°æ®åŠ è½½å·¥å…·å‡½æ•° | æ•°æ®åŠ è½½å™¨åˆ›å»ºå’Œåæ ‡å‡†åŒ–å‡½æ•° |

#### 1.4 è®­ç»ƒå™¨æ¨¡å— (`model/trainers/`)

| æ–‡ä»¶ | æ ¸å¿ƒç±»/åŠŸèƒ½ | ä½œç”¨æè¿° |
|------|------------|----------|
| `encoder_decoder_trainer.py` | `EncoderDecoderTrainer` | ç¼–ç å™¨-è§£ç å™¨è”åˆè®­ç»ƒ |
| `finetune_trainer.py` | `FinetuneTrainer` | åœ°éœ‡è§£ç å™¨å¾®è°ƒè®­ç»ƒ |
| `diffusion_trainer.py` | `DiffusionTrainer` | æ‰©æ•£æ¨¡å‹è®­ç»ƒ |
| `utils.py` | è®­ç»ƒå·¥å…·å‡½æ•° | å‚æ•°ç»Ÿè®¡ã€ç§å­è®¾ç½®ã€å­¦ä¹ ç‡è°ƒåº¦ç­‰ |
| `pytorch_ssim.py` | `SSIM` | ç»“æ„ç›¸ä¼¼æ€§æŸå¤±å‡½æ•° |
| `__init__.py` | - | è®­ç»ƒå™¨å¯¼å‡ºå’Œå·¥å…·å‡½æ•° |

#### 1.5 æ•°æ®ç”Ÿæˆæ¨¡å— (`model/generation/`)

| æ–‡ä»¶ | æ ¸å¿ƒç±»/åŠŸèƒ½ | ä½œç”¨æè¿° |
|------|------------|----------|
| `generator.py` | `UBDiffGenerator` | æ•°æ®ç”Ÿæˆå™¨ï¼Œæ”¯æŒæ‰¹é‡ç”Ÿæˆã€è´¨é‡è¯„ä¼°ã€æ’å€¼ |
| `visualizer.py` | `ModelVisualizer` | å¯è§†åŒ–å·¥å…·ï¼Œæ”¯æŒå¤šç§å›¾è¡¨å’Œå¯¹æ¯”å±•ç¤º |
| `__init__.py` | - | ç”Ÿæˆæ¨¡å—å¯¼å‡º |

### 2. Scripts è„šæœ¬æ¨¡å— (`scripts/`)

| è„šæœ¬ | åŠŸèƒ½ | å¯¹åº”è®­ç»ƒé˜¶æ®µ |
|------|------|-------------|
| `train_encoder_decoder.py` | ç¼–ç å™¨-è§£ç å™¨è®­ç»ƒ | ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¨¡å‹è®­ç»ƒ |
| `finetune_seismic_decoder.py` | åœ°éœ‡è§£ç å™¨å¾®è°ƒ | ç¬¬äºŒé˜¶æ®µï¼šè§£ç å™¨ä¸“é—¨åŒ– |
| `train_diffusion.py` | æ‰©æ•£æ¨¡å‹è®­ç»ƒ | ç¬¬ä¸‰é˜¶æ®µï¼šç”Ÿæˆæ¨¡å‹è®­ç»ƒ |
| `generate_data.py` | æ•°æ®ç”Ÿæˆå’Œè¯„ä¼° | ç”Ÿæˆé˜¶æ®µï¼šä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹ |

## ğŸš€ è®­ç»ƒæµç¨‹

### ä¸‰é˜¶æ®µè®­ç»ƒç­–ç•¥

```mermaid
graph LR
    A[åŸå§‹æ•°æ®] --> B[ç¼–ç å™¨-è§£ç å™¨è®­ç»ƒ]
    B --> C[åœ°éœ‡è§£ç å™¨å¾®è°ƒ]
    C --> D[æ‰©æ•£æ¨¡å‹è®­ç»ƒ]
    D --> E[æ•°æ®ç”Ÿæˆ]
```

1. **é˜¶æ®µ1 - ç¼–ç å™¨è§£ç å™¨è®­ç»ƒ**
   - è®­ç»ƒé€Ÿåº¦åœºç¼–ç å™¨å’ŒåŒè§£ç å™¨
   - å­¦ä¹ é€Ÿåº¦åœºåˆ°æ½œåœ¨ç©ºé—´çš„æ˜ å°„
   - å»ºç«‹é€Ÿåº¦åœºå’Œåœ°éœ‡æ•°æ®çš„åŸºæœ¬å…³è”

2. **é˜¶æ®µ2 - åœ°éœ‡è§£ç å™¨å¾®è°ƒ**
   - å†»ç»“ç¼–ç å™¨ï¼Œä¸“é—¨ä¼˜åŒ–åœ°éœ‡è§£ç å™¨
   - æé«˜åœ°éœ‡æ•°æ®é‡æ„è´¨é‡
   - ä½¿ç”¨SSIMç­‰é«˜çº§æŸå¤±å‡½æ•°

3. **é˜¶æ®µ3 - æ‰©æ•£æ¨¡å‹è®­ç»ƒ**
   - åœ¨æ½œåœ¨ç©ºé—´è®­ç»ƒæ‰©æ•£æ¨¡å‹
   - å­¦ä¹ ç”Ÿæˆé«˜è´¨é‡çš„æ½œåœ¨è¡¨ç¤º
   - æ”¯æŒæ— æ¡ä»¶ç”Ÿæˆ

## ğŸ“Š æ•°æ®æµå‘

```mermaid
graph TD
    A[é€Ÿåº¦åœºæ•°æ®] --> B[VelocityEncoder]
    B --> C[æ½œåœ¨ç©ºé—´è¡¨ç¤º]
    C --> D[VelocityDecoder]
    C --> E[SeismicDecoder]
    D --> F[é‡æ„é€Ÿåº¦åœº]
    E --> G[é‡æ„åœ°éœ‡æ•°æ®]
    
    H[å™ªå£°] --> I[æ‰©æ•£æ¨¡å‹]
    I --> C
```

## ğŸ› ï¸ æ ¸å¿ƒç‰¹æ€§

### æ¨¡å—åŒ–è®¾è®¡
- **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªæ¨¡å—ä¸“æ³¨ç‰¹å®šåŠŸèƒ½
- **æ¥å£æ¸…æ™°**: æ¨¡å—é—´é€šè¿‡å®šä¹‰è‰¯å¥½çš„æ¥å£äº¤äº’
- **æ˜“äºæ‰©å±•**: å¯è½»æ¾æ·»åŠ æ–°çš„ç¼–ç å™¨ã€è§£ç å™¨æˆ–å˜æ¢

### ç±»å‹å®‰å…¨
- **å…¨é¢ç±»å‹æ³¨è§£**: æ‰€æœ‰å‡½æ•°å’Œç±»éƒ½æœ‰è¯¦ç»†çš„ç±»å‹æç¤º
- **å‚æ•°éªŒè¯**: è¾“å…¥å‚æ•°çš„æ ¼å¼å’ŒèŒƒå›´æ£€æŸ¥
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### é…ç½®é©±åŠ¨
- **JSONé…ç½®**: æ•°æ®é›†å‚æ•°é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†
- **å‘½ä»¤è¡Œå‚æ•°**: è®­ç»ƒè„šæœ¬æ”¯æŒä¸°å¯Œçš„å‘½ä»¤è¡Œé€‰é¡¹
- **çµæ´»é…ç½®**: æ”¯æŒä¸åŒæ•°æ®é›†å’Œå®éªŒè®¾ç½®

### å®éªŒè®°å½•
- **WandBé›†æˆ**: è‡ªåŠ¨è®°å½•è®­ç»ƒæŒ‡æ ‡å’Œç”Ÿæˆæ ·æœ¬
- **æ£€æŸ¥ç‚¹ç®¡ç†**: å®šæœŸä¿å­˜å’ŒåŠ è½½æ¨¡å‹çŠ¶æ€
- **å¯è§†åŒ–æ”¯æŒ**: å†…ç½®ä¸°å¯Œçš„å¯è§†åŒ–å·¥å…·

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

1. **ç¯å¢ƒå‡†å¤‡**
   ```bash
   pip install torch torchvision numpy matplotlib seaborn
   pip install wandb  # å¯é€‰ï¼Œç”¨äºå®éªŒè®°å½•
   ```

2. **ç¬¬ä¸€é˜¶æ®µè®­ç»ƒ**
   ```bash
   python scripts/train_encoder_decoder.py \
     --train_data /path/to/seismic/data \
     --train_label /path/to/velocity/data \
     --dataset flatvel-a \
     --epochs 300
   ```

3. **ç¬¬äºŒé˜¶æ®µå¾®è°ƒ**
   ```bash
   python scripts/finetune_seismic_decoder.py \
     --checkpoint_path /path/to/encoder_decoder/checkpoint \
     --train_data /path/to/seismic/data \
     --train_label /path/to/velocity/data \
     --dataset flatvel-a
   ```

4. **ç¬¬ä¸‰é˜¶æ®µæ‰©æ•£è®­ç»ƒ**
   ```bash
   python scripts/train_diffusion.py \
     --checkpoint_path /path/to/finetuned/checkpoint \
     --train_data /path/to/seismic/data \
     --train_label /path/to/velocity/data \
     --dataset flatvel-a
   ```

5. **æ•°æ®ç”Ÿæˆ**
   ```bash
   python scripts/generate_data.py \
     --checkpoint_path /path/to/final/checkpoint \
     --dataset flatvel-a \
     --num_samples 1000 \
     --visualize
   ```

### é«˜çº§ç”¨æ³•

- **è‡ªå®šä¹‰æ•°æ®é›†**: ä¿®æ”¹`dataset_config.json`æ·»åŠ æ–°æ•°æ®é›†
- **æ¨¡å‹è°ƒä¼˜**: è°ƒæ•´ç½‘ç»œæ¶æ„å‚æ•°å’Œè®­ç»ƒè¶…å‚æ•°
- **è´¨é‡è¯„ä¼°**: ä½¿ç”¨å†…ç½®è¯„ä¼°å·¥å…·åˆ†æç”Ÿæˆè´¨é‡
- **æ½œåœ¨ç©ºé—´æ¢ç´¢**: åˆ©ç”¨æ’å€¼åŠŸèƒ½æ¢ç´¢æ½œåœ¨ç©ºé—´ç»“æ„

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

é¡¹ç›®æä¾›å¤šç§æ€§èƒ½ç›‘æ§å’Œè¯„ä¼°å·¥å…·ï¼š

- **è®­ç»ƒæŒ‡æ ‡**: æŸå¤±å‡½æ•°ã€SSIMã€é‡æ„è¯¯å·®
- **ç”Ÿæˆè´¨é‡**: ç»Ÿè®¡æŒ‡æ ‡ã€åˆ†å¸ƒå¯¹æ¯”ã€Q-Qå›¾
- **å¯è§†åŒ–å¯¹æ¯”**: çœŸå®vsç”Ÿæˆæ•°æ®çš„å¹¶æ’å±•ç¤º
- **æ¨¡å‹åˆ†æ**: å‚æ•°ç»Ÿè®¡ã€è®¡ç®—å¤æ‚åº¦åˆ†æ

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°ç»„ä»¶
1. åœ¨`model/components/`ä¸­åˆ›å»ºæ–°æ¨¡å—
2. å®ç°å¿…è¦çš„æ¥å£å’Œç±»å‹æ³¨è§£
3. åœ¨`__init__.py`ä¸­å¯¼å‡ºæ–°ç»„ä»¶
4. æ›´æ–°`UBDiff`ç±»ä»¥é›†æˆæ–°ç»„ä»¶

### æ–°æ•°æ®é›†æ”¯æŒ
1. æ›´æ–°`dataset_config.json`é…ç½®
2. å¦‚éœ€ç‰¹æ®Šé¢„å¤„ç†ï¼Œæ‰©å±•`transforms.py`
3. æµ‹è¯•æ•°æ®åŠ è½½å’Œæ ‡å‡†åŒ–æµç¨‹

### æ–°è®­ç»ƒç­–ç•¥
1. ç»§æ‰¿ç°æœ‰è®­ç»ƒå™¨åŸºç±»
2. å®ç°ç‰¹å®šçš„è®­ç»ƒé€»è¾‘
3. æ·»åŠ å¯¹åº”çš„å‘½ä»¤è¡Œè„šæœ¬

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `README.md`: é¡¹ç›®åŸºæœ¬ä»‹ç»å’Œå¿«é€Ÿå¼€å§‹
- å„æ¨¡å—`__init__.py`: è¯¦ç»†çš„APIæ–‡æ¡£
- è„šæœ¬æ–‡ä»¶: å‘½ä»¤è¡Œå‚æ•°è¯´æ˜å’Œä½¿ç”¨ç¤ºä¾‹

---

è¿™ä¸ªç»“æ„æä¾›äº†ä»æ•°æ®é¢„å¤„ç†åˆ°æ¨¡å‹è®­ç»ƒå†åˆ°æ•°æ®ç”Ÿæˆçš„å®Œæ•´pipelineï¼Œå…·æœ‰è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚ 